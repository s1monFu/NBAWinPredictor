---
title: "STAT240 FinalProject Draft"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(kableExtra)
library(tidymodels)
source("../../scripts/viridis.R")
source("../../scripts/ggprob.R")
```

Group Number: 313B

Group Members: Heidee Xiong, Jack Wallenta, Clayton Goter, Simon Fu


# Introduction:
The motivation for our analysis is to figure out what variables give an NBA team a greater chance of winning a basketball game. Our questions of interest examine whether the location of a game, such as home or away, influences the chance of a team to win, and whether the conference that a team belongs to is more likely to win. We also will compare different game statistics to help us predict their relationships to a winning team. In order for an NBA team to win a game, it is more favorable for a team to belong in the Western conference, while having higher 3-point and field goal percentages.
 
# Background:

NBA basketball is a sport loved by many throughout the world. Games are played by teams in different states, each with their own unique set of players and skills that change every season. Most fans are excited to see which team will come out victorious in their respective divisions at the end of the season and go as far to make bets on which team will win. Because of this, fans are itching to know what makes a team a winning team to predict the reigning champion. In this report, we examine the different statistics that are collected from the NBA games recorded to see if there is a leading variable that can predict the outcome of the game. We examine every game played in each division and seek to find any patterns over time.

A variety of statistics from each NBA game have been recorded and published since the introduction of the League. For this project, we picked data from every NBA game dating from the 2003-2004 season all the way up to the 2019-2020 season. This data was collected and organized by data scientist Nathan Luaga, which he then published on kaggle here: https://www.kaggle.com/nathanlauga/nba-games. Nathan scraped the data from the NBA’s stat webpage from https://www.nba.com/stats/ to create the csv files used in this report. The dataset is still being updated weekly with games from the present NBA season. Due to the large amount of variables collected, he has divided the data into five different data sets. The datasets we specifically used are games.csv for individual game data, rankings.csv for conference information, and teams.csv for team identification information.

An unusual factor that may affect the interpretation of the results is that the team’s players and reputations can change every season/year, meaning that there is no conclusive consistency for figuring out which team is the “best” or “worst.” We will only be able to conclude what statistics may increase a team’s chances of winning.

Another unusual factor that will affect our interpretation of results is that there is missing data from some of the earlier NBA games (all from 2003). We decided to filter out these values so as to not count these games when we analyze the data. This will change the number of games played from the 2003 season. 
```{r, echo=FALSE}
nba_vars = tibble(
  Name = c("SEASON", "Home_team", "Home_team_conf", "Home_Team_ID", "HOME_TEAM_WINS", "AWAY_TEAM_WINS", "Away_team", "Away_team_conf", "Away_Team_ID", "PTS_home", "FG_PCT_home", "FT_PCT_home", "FG3_PCT_home", "AST_home", "REB_home", "PTS_away", "FG_PCT_away", "FT_PCT_away", "FG3_PCT_away", "AST_away", "REB_away"),
  Description = c("The season (year) of the game",
                  "The home team",
                  "The home team's conference",
                  "The home team's unique ID number",
                  "If the home team won (1 = yes, 0 = no)",
                  "If the away team won (1 = yes, 0 = no)",
                  "The away team", 
                  "The away team's conference",
                  "The away team's unique ID number",
                  "The home team's points",
                  "The home team's field goal percentage",
                  "The home team's free throw percentage",
                  "The home team's three point percentage",
                  "The home team's # of assists",
                  "The home team's # of rebounds",
                  "The away team's points",
                  "The away team's field goal percentage",
                  "The away team's free throw percentage",
                  "The away team's three point percentage",
                  "The away team's # of assists", 
                  "The away team's # of rebounds"
                  ))

nba_variables = nba_vars %>% 
  kable(caption = "Key Variables from the NBA Data Set") %>% 
  kable_styling(position = "left", full_width = FALSE,
                bootstrap_options = c("striped"))

nba_variables

```
Using these statistics, we can answer our questions of interest. For example, we could look at the numbers of total wins for home teams between 2004 and 2020 as well as the total wins for away teams, compare the trends, and determine if home teams win more often than away teams. A less obvious example would be grouping by team, taking each value of "three_pct_home" and "three_pct_away" and plotting them with the percentage on the y axis and team on the x axis and creating a different colored line that plots the the win percentage of a team on the y axis and the team on the x axis. With these lines we can likely determine if there is a correlation between three point percentages and winning.
 
The remainder of the report will examine the following questions about trends in NBA games:
Our topic is NBA games from the 2004 season through the 2020 season.
Does the location of a game influence the chance of a team to win?
Do teams in the Western Conference win more often than teams in the Eastern Conference?
Does the team with the higher three point percentage between the two (per game) win more often than the team with the lower three point percentage? Do teams with higher three point percentages win more often overall?
What is the probability of a team scoring 150 points or more?
What is the most important statistic that determines whether or not a team wins a game?


# Analysis

## 1.Does the location of a game influence the chance of a team to win? Do teams in the Western Conference win more often than teams in the Eastern Conference?

```{r, include=FALSE}
games <- read_csv("games.csv") %>% 
  filter(GAME_DATE_EST < "2020-12-11")
teams <- read_csv("teams.csv")
ranking <- read_csv("ranking.csv")

teams_data <- teams %>% 
  select(TEAM_ID, NICKNAME) %>% 
  left_join(ranking, by = "TEAM_ID") %>% 
  select(TEAM_ID, NICKNAME, CONFERENCE) %>% 
  distinct()

games_data1 <- games %>% 
  select(SEASON, HOME_TEAM_ID, VISITOR_TEAM_ID, PTS_home, FG_PCT_home, FT_PCT_home, FG3_PCT_home, AST_home, REB_home, PTS_away, FG_PCT_away, FT_PCT_away, FG3_PCT_away, AST_away, REB_away, HOME_TEAM_WINS) %>% 
  rename(TEAM_ID = HOME_TEAM_ID) %>% 
  left_join(teams_data, by = "TEAM_ID") %>% 
  rename(Home_team = NICKNAME, Home_team_conf = CONFERENCE) 

games_data = games_data1 %>% 
  rename(Home_Team_ID = TEAM_ID) %>% 
  rename(TEAM_ID = VISITOR_TEAM_ID) %>% 
  left_join(teams_data, by = "TEAM_ID") %>% 
  rename(Away_team = NICKNAME) %>% 
  rename(Away_team_conf = CONFERENCE) %>% 
  rename(Away_Team_ID = TEAM_ID) %>% 
  mutate(AWAY_TEAM_WINS = case_when(HOME_TEAM_WINS == 0 ~ 1,
                                    HOME_TEAM_WINS == 1 ~ 0)) %>% 
  select(SEASON, Home_team, Home_team_conf, Home_Team_ID, HOME_TEAM_WINS, AWAY_TEAM_WINS, Away_team, Away_team_conf, Away_Team_ID, everything())
  
games_data = games_data %>% 
  filter(is.na(games_data$FG3_PCT_home) == FALSE)

games_data

```

```{r, include=FALSE}
homewins = games_data %>% 
  group_by(Home_Team_ID) %>%
  mutate(total = n()) %>%
  mutate(num_home_wins = sum(HOME_TEAM_WINS)) %>% 
  group_by(Home_Team_ID) %>% 
  summarize(num_home_wins = num_home_wins, win_p = num_home_wins/total, three_p = sum(FG3_PCT_home), three_pct = three_p/total, total = total) %>% 
  distinct() %>% 
  select(-three_p)

homewins = homewins  %>% 
  rename(TEAM_ID = Home_Team_ID) %>% 
  left_join(teams_data, by = "TEAM_ID")

#homewins

awaywins = games_data %>% 
  group_by(Away_Team_ID) %>%
  mutate(total = n()) %>%
  mutate(num_away_wins = sum(AWAY_TEAM_WINS)) %>% 
  group_by(Away_Team_ID) %>% 
  summarize(num_away_wins = num_away_wins, win_p = num_away_wins/total, three_p = sum(FG3_PCT_away), three_pct = three_p/total, total = total) %>% 
  distinct() %>% 
  select(-three_p)

awaywins = awaywins  %>% 
  rename(TEAM_ID = Away_Team_ID) %>% 
  left_join(teams_data, by = "TEAM_ID")

#awaywins

combinedwins = homewins %>% 
  left_join(awaywins, by = "TEAM_ID") %>% 
  mutate( three_pct = ((three_pct.x + three_pct.y)/2), 
         total_games = total.x + total.y, 
         total_wins = num_home_wins + num_away_wins,
         win_pct = (total_wins / total_games)) %>% 
  select(TEAM_ID, NICKNAME.x, CONFERENCE.x, win_pct, three_pct, total_games) %>% 
  distinct() %>% 
  rename(NICKNAME = NICKNAME.x, CONFERENCE = CONFERENCE.x) %>% 
  filter((NICKNAME != "Pelicans" | CONFERENCE != "East"))

combinedwins

```


```{r,echo=FALSE}
combinedwins %>% 
  ggplot() +
  geom_col(aes(x=NICKNAME,y=win_pct * 100,fill = CONFERENCE)) +
  theme( axis.text.x = element_text(angle=45, hjust=1) ) +
  geom_hline(yintercept=50,color="blue")+
  ggtitle("Win Rates")+
  xlab("Team Name") +
  ylab("Win Percentage")
```

 
We infer that Western Conference teams win more often than teams in the Eastern conference. To explore this question, we made a bar graph by setting the variable (“NICKNAME”) to the x-axis to represent each team and “win percentage” to the y-axis. We then color coded each bar to its respective conference of East or West. We also made sure to include a horizontal line on the graph at the 0.50 mark to help visualize the teams whose winning percentages were greater than 50%. Based on the bar graph we made, it can be concluded that teams in the Western conference win more often than those in the Eastern, with 16 teams above 50% and 14 below 50%.


## 2.Do teams with higher three point percentages win more often overall?

```{r, echo=FALSE}
avgs = combinedwins %>% 
  ungroup() %>% 
  summarise(avg_win_pct = sum(win_pct)/30, avg_3pt_pct = sum(three_pct)/30)
# avgs
  

ggplot(data = combinedwins, aes(x = NICKNAME)) +
  geom_point(aes(y = win_pct*100), color = "red") +
  geom_point(aes(y = three_pct*100), color = "green") +
  labs(x = "Team", y = "%", color = "Legend") +
  geom_hline(yintercept = 0.4990802*100, color = "black", linetype = "dashed") +
  geom_hline(yintercept = 0.3520847*100, color = "black", linetype = "dashed") +
  coord_flip() +
  ggtitle("2004-2020 NBA Team Stats", subtitle = "Red Dots = Win %, Green Dots = Three Point % (dashed lines = NBA average)")

```

As a group, we predicted that teams with higher three point percentages overall win more than teams with lower three point percentages. To create this data, we took our main “games_data” data frame, grouped all the games based on the home team, and added columns for the total wins and total games played for each home team. Additionally, we summarized the average three point percentage for each home team. We repeated this process for the away teams as well (re-read the above two sentences but replace all “home” with “away”). 

After we had our two data frames, one for home teams and one for away teams, we joined them into one by their unique team ID’s. Then, we summarised the total (home and away) stats for each of the 30 teams. The three new variables in this data frame that do not appear in “games_data” are win_pct, three_pct, and total_games which represent the win percentage, three point percentage, and number of total games for each team. It is worth noting that we did not have three-pointer-attempts or three-pointers-made data, so the three_pct variable is an average of the home and away percentages. The win percentage is accurate as it was made using the number of wins and number of total games for each team.


## 3.What is the probability of a team scoring 150 points or more?

```{r, echo=FALSE}
games_data2 = games_data %>% 
  select(Home_Team_ID, PTS_home, PTS_away, ) %>% 
  pivot_longer(cols = c(PTS_home, PTS_away),names_to = "name",values_to = "PTS")
```

```{r, echo=FALSE}
PTS = games_data2 %>% 
  pull(PTS)
t.test(PTS)
1- pt(150, df=53071)
```

We infer that the probability of a team scoring 150 points or more is very small. To calculate the percentage of a team scoring 150 points or more, we pulled and combined  “PTS_home” with “PTS_away” to the new variable “PTS”. We then made a one sample t-test on this variable and got a 95 percent confidence interval on the scores as well as the degree of freedom. We also calculated the probability of a team scoring 150 points or more using the calculated degree of freedom. Based on the result, we can conclude that the probability of a team scoring 150 points or more is 0.

## 4.What is the most important statistic that determines whether or not a team wins a game?

```{r, echo=FALSE}
games_data3 = games_data %>%
  mutate(FG_PCT_home = FG_PCT_home*100, FG3_PCT_home = FG3_PCT_home*100)

fit <- lm(HOME_TEAM_WINS ~   FG_PCT_home + FG3_PCT_home + AST_home + 
            REB_home + PTS_away, data=games_data3)
summary(fit)
coeffs = fit$coefficients %>%
  as_tibble() %>%
  mutate(Variable = c("Intercept", "FG_PCT_home", "FG3_PCT_home", "AST_home", "REB_home", "PTS_away")) %>%
  filter(Variable != "Intercept")
  
ggplot(coeffs)+
  geom_col(aes(x = Variable, y=value), fill = "blue") +
  ggtitle("Coefficient Values in Regression Model")

```


For our last analysis, we wanted to weigh the importance of in game statistics in determining if a team wins the game. In order to accomplish this, we designed a linear regression model which fits multiple commonly recorded game statistics, and regressed it on whether the home team wins or not. Because the home team wins variable is a dummy variable, we know that all coefficient values will be in between 0 and 1. Upon running the regression, we immediately noticed that the T-statistic for all variables is very high, meaning that all variables in this regression have a significant impact on the outcome of the game. On top of this, we also notice that the home FG percentage variable has the highest coefficient value out of all the variables at ~0.037. The Away PTS variable being negative is expected, however one unexpected coefficient value is the value of  ~ -0.004 for Home Team Assists. This was unexpected as typically, assists are a statistic that is thought to contribute positively to a teams success.

# Discussion

## 1.Does the location of a game influence the chance of a team to win? Do teams in the Western Conference win more often than teams in the Eastern Conference?
Based on the graph from the NBA games between 2004-2020, we can see that on average, a team in the Western conference wins more often than a team in the Eastern conference. A short-coming of this analysis is that the number between those in the Western conference that win compared to those in the Eastern conference is 2, which is not very significant. This poses the question of whether what conference a team belongs to is associated with a particular advantage, and also begs the question as to why the teams in the Western conference tend to win more often. It would be interesting to look at data that maps out certain trends between the two conferences, like looking at which conference the best NBA players tend to play in, to refine our understanding. Overall, according to our graph, it seems that being on a team in the Western conference will correlate to a higher winning percentage.
 

## 2.Do teams with higher three point percentages win more often overall?
Our graph contains the three point percentage and win percentage on the x-axis and the team names on the y-axis. The two dashed lines represent the NBA average for each of them (the left line is three point percentage, the right line is win percentage). Looking at our graph, we see that there are 14 teams that have a below average three point percentage and 14 teams that have a below average win percentage. Of the 14 teams that have below average three point percentage, 9 of them (64.3%) also fall in the bottom 14 teams in terms of win percentage. On the flip side, 16 teams have an above average three point percentage and 16 teams have an above average win percentage. Of the 16 teams that have an above average three point percentage, 11 of them (68.9%) also have above average win percentages. From these numbers we can see a pattern that teams with higher three point percentages overall win more often than teams with lower three point percentages. For example, if one were to draw a random team from a hat with all 30 teams and that team has an average three point percentage that is above the league average, there is a 68% chance that said team also has a total win percentage that is above league average. 

## 3.What is the probability of a team scoring 150 points or more?
Based on the t-test result, we are 95 percent confident that the point is between 101.2787 and 101.5050. The average point for all teams at all time is 101.3918. We then used the degree of freedom from the t-test to calculate the probability of a team scoring 150 points or more. The result is 0, indicating that it is almost impossible for a team to score 150 points or more. Some new data that we could collect to refine our understanding is to find out how those points are broken down, looking at, for example, how much percent of those points are made from 2-point shots versus free throws (1-point). Based on those percentages, we could look at the possible ways a team would be able to reach 150 points in a game, since it is not entirely impossible. In general, however, the possibility of a team scoring more than 150 points is very slim, which tells us that most winning games will fall around a score of 101 points.
 
## 4.What is the most important statistic that determines whether or not a team wins a game?
As the coefficient value of FG percentage is the highest among all the variables in our regression, paired with the very large t-statistic, we can conclude that a change in the home teams FG Percentage has the most weight in predicting the outcome of a game. However, the home assists coefficient being negative and very small did spark further analysis. One of the first ways we could interpret negative coefficients was that teams that move the ball less tend to win more. However, because the number is so small we believe that both passing, teamwork oriented teams as well as, Star heavy, isolation ball style teams have a very equal chance of success during the average NBA game. After interpreting our results we did notice some ways we could improve our approach to answering this question. First of all, finding a data set with more advanced statistics such as turnovers, win shares, win streaks, ect. would provide extra depth to our model that was lost in the error. Another way we increase the accuracy of this model would be separating the regular season games from the playoff games, as typically there’s a change in the mean statistics of NBA games between the two.

# References
We are using data from Kaggle found here: https://www.kaggle.com/nathanlauga/nba-games

This data set was created by Nathan Lauga who scraped the data from the NBA's stat webpage: https://www.nba.com/stats/ to create csv files.
